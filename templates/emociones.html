{% extends "base.html" %}
{% block title %}Detector de emociones{% endblock %}

{% block content %}

<style>
  /* Fondo din谩mico */
  body {
    background: linear-gradient(135deg, #00e0ff, #2d62ff, #8a00ff);
    background-size: 400% 400%;
    animation: gradientAnim 12s ease infinite;
  }

  @keyframes gradientAnim {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Tarjeta principal */
  .emotion-card {
    background: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    border: none;
    overflow: hidden;
    animation: fadeIn 0.6s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Header */
  .emotion-header {
    background: linear-gradient(90deg, #ffcc00, #ffdd55);
    padding: 15px 20px;
    border-bottom: none;
  }

  .logo-small {
    width: 45px;
    margin-right: 12px;
  }

  /* Bot贸n estilo NeuroFace */
  .btn-neuro {
    background: linear-gradient(90deg, #7a00ff, #2d62ff);
    border: none;
    color: white !important;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 12px;
    transition: 0.2s ease;
  }

  .btn-neuro:hover {
    transform: scale(1.03);
    opacity: 0.9;
  }

  /* C谩mara */
  #videoEmotion {
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  /* Estado */
  #emotionStatus {
    font-weight: bold;
    letter-spacing: 0.3px;
  }
</style>

<div class="row justify-content-center mt-4">
  <div class="col-md-8">

    <div class="card emotion-card shadow-lg">

      <!-- HEADER -->
      <div class="card-header emotion-header d-flex align-items-center">
        <img src="{{ url_for('static', filename='logo.jpg') }}" class="logo-small">

        <div>
          <h5 class="mb-0">Detector de Emociones</h5>
          <small>Analiza tu rostro con IA</small>
        </div>

        <div class="ms-auto small fw-bold">
           {{ username }}
        </div>
      </div>

      <!-- BODY -->
      <div class="card-body">

        <p class="text-muted">
          Col贸cate frente a la c谩mara con buena iluminaci贸n. Este m贸dulo analizar谩 tus expresiones para estimar
          tu emoci贸n actual usando Face++. Luego generar谩 una imagen y una historia personalizada seg煤n tu emoci贸n.
        </p>

        <div class="text-center mb-3">
          <video id="videoEmotion"
                 width="320"
                 height="240"
                 autoplay
                 class="border rounded shadow-sm">
          </video>

          <canvas id="canvasEmotion"
                  width="320"
                  height="240"
                  class="d-none">
          </canvas>
        </div>

        <div class="d-flex justify-content-center mb-2">
          <button id="analyzeEmotionBtn" class="btn-neuro">
            Analizar emoci贸n
          </button>
        </div>

        <div id="emotionStatus"
             class="mt-3 text-center text-muted small">
          Iniciando c谩mara...
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>

<script>
  // Inicializar c谩mara (l贸gica original sin cambios)
  initCamera('videoEmotion', 'canvasEmotion', null, null, null);

  const videoEmotion = document.getElementById('videoEmotion');
  const canvasEmotion = document.getElementById('canvasEmotion');
  const analyzeBtn = document.getElementById('analyzeEmotionBtn');
  const emotionStatus = document.getElementById('emotionStatus');

  analyzeBtn.addEventListener('click', async () => {

    if (!videoEmotion.videoWidth || !videoEmotion.videoHeight) {
      emotionStatus.textContent = "Esperando a que la c谩mara est茅 lista...";
      emotionStatus.className = "mt-3 text-center text-secondary small";
      return;
    }

    const ctx = canvasEmotion.getContext('2d');
    let width = videoEmotion.videoWidth || 320;
    let height = videoEmotion.videoHeight || 240;

    const maxWidth = 480;
    if (width > maxWidth) {
      const scale = maxWidth / width;
      width = maxWidth;
      height = height * scale;
    }

    canvasEmotion.width = width;
    canvasEmotion.height = height;
    ctx.drawImage(videoEmotion, 0, 0, width, height);

    const dataUrl = canvasEmotion.toDataURL('image/jpeg', 0.7);

    emotionStatus.textContent = "Analizando tu emoci贸n...";
    emotionStatus.className = "mt-3 text-center text-secondary small";

    const formData = new FormData();
    formData.append('photo', dataUrl);

    try {
      const response = await fetch('{{ url_for("api_emocion") }}', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      if (result.success) {
        emotionStatus.textContent = "Emoci贸n detectada: " + result.emotion + ". Preparando tu experiencia...";
        emotionStatus.className = "mt-3 text-center text-success small";

        if (result.redirect_url) {
          window.location.href = result.redirect_url;
        }
      } else {
        emotionStatus.textContent = result.message || "No se pudo detectar tu emoci贸n.";
        emotionStatus.className = "mt-3 text-center text-danger small";
      }

    } catch (error) {
      console.error(error);
      emotionStatus.textContent = "Error al conectar con el servidor.";
      emotionStatus.className = "mt-3 text-center text-danger small";
    }
  });
</script>
{% endblock %}
